<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sistem ChiliGuard</title>
    <!-- FONT AWESOME -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <style>
        body { 
            font-family: Arial; 
            margin: 0; 
            background: #ffffff; 
        }
        .container { 
            padding: 20px; 
            padding-bottom: 120px; 
        }
        .title {
            font-size: 30px;
            font-weight: 900;
            color: #CE2F2F;
            line-height: 1.3;
            margin-bottom: 40px;
            -webkit-text-stroke: 0.3px #ffffff;
            text-shadow: 0px 5px 8px rgba(0,0,0,0.3),
                        -0.5px -0.5px 0 #ffffff,
                        0.5px 0.5px 0 #ffffff;

            text-align: center;  /* <-- ini membuat tulisan di tengah */
        }

        .tab-box { display: flex; justify-content: center; margin-bottom: 20px; }
        .tab { padding: 10px 28px; border-radius: 25px; font-size: 14px; cursor: pointer; font-weight: bold;
               border: 1.5px solid #dcdcdc; background: #ffffff; color: #444; transition: 0.25s;
               box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .tab:first-child { border-top-right-radius: 0; border-bottom-right-radius: 0; }
        .tab:last-child { border-top-left-radius: 0; border-bottom-left-radius: 0; }
        .tab.active { background: #CE2F2F; color: #fff; border-color: #CE2F2F; box-shadow: 0 3px 6px rgba(0,0,0,0.2); }
        .card { border: 1.5px solid #CE2F2F; border-radius: 18px; padding: 18px; margin-bottom: 18px;
                box-shadow: 0 3px 6px rgba(0,0,0,0.12); }
        .card-title { font-size: 18px; font-weight: bold; display: flex; gap: 8px; align-items: center; margin-bottom: 14px; }
        .device-box { border: 1px solid #cfcfcf; padding: 14px; border-radius: 14px; display: flex;
                      justify-content: space-between; align-items: center; background: #f9fff9; transition: 0.25s; }
        .device-name { font-size: 16px; font-weight: bold; }
        .device-status { font-size: 13px; color: #555; }
        .check-icon { font-size: 22px; color: #2ecc71; transition: 0.25s; }
        .tank-info { font-size: 14px; margin-bottom: 8px; }
        .progress-wrap { background: #e3e3e3; width: 100%; height: 10px; border-radius: 20px; overflow: hidden; margin: 8px 0; }
        .progress-fill { height: 100%; width: 0%; background: #3579ff; border-radius: 20px; transition: width 0.4s; }
        .small-desc { font-size: 13px; color: #444; margin-top: 6px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: #fff;
                      display: flex; justify-content: space-around; align-items: center; border-top: 2px solid #CE2F2F;
                      border-radius: 15px 15px 0 0; }
        .nav-item { text-align: center; font-size: 12px; color: #888; }
        .nav-item i { font-size: 20px; margin-bottom: 3px; }
        .active { color: #CE2F2F; font-weight: bold; }
    </style>
</head>

<body>
<div class="container">
    <h1 class="title">Sistem</h1>
    <div class="tab-box">
        <div class="tab active">Smart System</div>
        <div class="tab">Panduan Perakitan</div>
    </div>

    <!-- STATUS PERANGKAT -->
    <div class="card">
        <div class="card-title">
            <i class="fa-solid fa-gear" style="color:#CE2F2F;"></i> Status Perangkat
        </div>
        <div class="device-box" id="deviceBox">
            <div>
                <div class="device-name">ESP32 ChiliGuard Home</div>
                <div class="device-status" id="deviceStatus">Memeriksa...</div>
            </div>
            <i class="fa-solid fa-circle-check check-icon" id="deviceIcon"></i>
        </div>
    </div>

    <!-- TANGKI AIR -->
    <div class="card">
        <div class="card-title">
            <i class="fa-solid fa-droplet" style="color:#3579ff;"></i> Tangki Penampungan Air
        </div>
        <div class="tank-info">Kapasitas Total <b style="float:right;">5 Liter</b></div>
        <div class="tank-info">Level Air Saat Ini <b style="float:right;" id="waterPercent">0%</b></div>
        <div class="progress-wrap"><div class="progress-fill" id="progressFill"></div></div>
        <div class="small-desc" id="waterVolume">≈ 0 Liter tersedia</div>
    </div>

</div>

<!-- NAVIGATION -->
<div class="bottom-nav">
    <div class="nav-item" id="navBeranda"><i class="fa-solid fa-house"></i><br>Beranda</div>
    <div class="nav-item" id="navEdukasi"><i class="fa-solid fa-graduation-cap"></i><br>Edukasi</div>
    <div class="nav-item" id="navNotifikasi"><i class="fa-solid fa-bell"></i><br>Notifikasi</div>
    <div class="nav-item active"><i class="fa-solid fa-gear"></i><br>Sistem</div>
</div>

<script>
    document.getElementById("navBeranda").addEventListener("click", function() {
        window.location.href = "monitoring.html";
    });
    document.getElementById("navEdukasi").addEventListener("click", function() {
        window.location.href = "edukasi.html";
    });
    document.getElementById("navNotifikasi").addEventListener("click", function() {
        window.location.href = "notifikasi.html";
    });
</script>

<script>
const sensorURL = "https://chiliguard-home-default-rtdb.firebaseio.com/sensor.json";
const espStatusURL = "https://chiliguard-home-default-rtdb.firebaseio.com/esp_status.json";

let lastESPUpdate = 0; // waktu terakhir ESP update (ms)

// Update sensor setiap 2 detik
setInterval(loadSensorData, 2000);

function loadSensorData() {
    fetch(sensorURL)
        .then(res => res.json())
        .then(data => {
            if (!data) return;

            const volume = data.volume_liter ?? 0;

            // Hitung persentase air
            let persentase = (volume / 5) * 100;
            if (persentase > 100) persentase = 100;

            document.getElementById("waterPercent").textContent = persentase.toFixed(0) + "%";
            document.getElementById("progressFill").style.width = persentase + "%";
            document.getElementById("waterVolume").textContent = "≈ " + volume.toFixed(2) + " Liter tersedia";

            // Simpan waktu update ESP terakhir dari sensor
            lastESPUpdate = Date.now();
        });
}

// ================================
// CEK KONEKSI ESP BERDASARKAN last_seen
// ================================
setInterval(loadESPStatus, 2000);

function loadESPStatus() {
    fetch(espStatusURL)
        .then(res => res.json())
        .then(statusData => {
            if (!statusData || !statusData.last_seen) {
                updateESPUI(false);
                return;
            }

            // last_seen dalam detik UNIX timestamp, ubah ke ms
            const lastSeenMS = statusData.last_seen * 1000;
            const now = Date.now();

            // ESP dianggap offline jika >5 detik tidak update
            const isOnline = (now - lastSeenMS) <= 10000;
            updateESPUI(isOnline);
        })
        .catch(err => updateESPUI(false));
}

function updateESPUI(isOnline) {
    const box = document.getElementById("deviceBox");
    const statusText = document.getElementById("deviceStatus");
    const icon = document.getElementById("deviceIcon");

    if (isOnline) {
        statusText.innerHTML = "<b style='color:green;'>Terhubung</b>";
        icon.className = "fa-solid fa-circle-check check-icon";
        icon.style.color = "green";
        box.style.background = "#f0fff0";
    } else {
        statusText.innerHTML = "<b style='color:red;'>Tidak Terhubung</b>";
        icon.className = "fa-solid fa-circle-xmark check-icon";
        icon.style.color = "red";
        box.style.background = "#fff0f0";
    }
}
</script>

</body>
</html>
